input {
#      beats {
#            port => "5044"
#      }
      file {
           path => "/home/hidepin/log/sar*"
           start_position => "beginning"
           type => "sysstat"
      }
}
filter {
       mutate {
              gsub => [
                   "source", ".*/", "",
                   "path", ".*/", ""
              ]
       }
       if [message] =~ /^Linux/ {
          grok {
               match => {
                     "message" => "Linux %{NOTSPACE} \(%{IPORHOST:hostname}\)%{SPACE}%{YEAR:year}年%{MONTHNUM2:month}月%{MONTHDAY:day}.*"
               }
          }
          ruby {
               init => "@@sysstat_hostname = '', @@sysstat_date = '', @@sysstat_report = ''"
               code => "
                    @@sysstat_hostname = event.get('hostname');
                    @@sysstat_date = event.get('year') + event.get('month') + event.get('day');
                    "
          }
          drop {}
       } else if  [message] !~ /^\d\d時\d\d分\d\d秒/ {
          drop {}
       } else if  [message] =~ /LINUX RESTART/ {
          drop {}
       } else if  [message] =~ /CPU/ {
          ruby {
               code => "@@sysstat_report = 'cpu'"
          }
          drop {}
       } else if  [message] =~ /proc\/s/ {
          ruby {
               code => "@@sysstat_report = 'task_system_switch'"
          }
          drop {}
       } else if  [message] =~ /pswpin\/s/ {
          ruby {
               code => "@@sysstat_report = 'swapping_stat'"
          }
          drop {}
       } else if  [message] =~ /pgpgin\/s/ {
          ruby {
               code => "@@sysstat_report = 'paging_stat'"
          }
          drop {}
       } else if  [message] =~ /tps/ {
          ruby {
               code => "@@sysstat_report = 'io'"
          }
          drop {}
       } else if  [message] =~ /frmpg\/s/ {
          ruby {
               code => "@@sysstat_report = 'memory_stat'"
          }
          drop {}
       } else if  [message] =~ /kbmemfree/ {
          ruby {
               code => "@@sysstat_report = 'memory_util'"
          }
          drop {}
       } else if  [message] =~ /kbswpfree/ {
          ruby {
               code => "@@sysstat_report = 'swap_util'"
          }
          drop {}
       } else if  [message] =~ /dentunusd/ {
          ruby {
               code => "@@sysstat_report = 'inode_file_other_kernel_tables'"
          }
          drop {}
       } else if  [message] =~ /runq-sz/ {
          ruby {
               code => "@@sysstat_report = 'queue_load_averages'"
          }
          drop {}
       } else {
          ruby {
               code => "
                    event.set('sysstat_hostname', @@sysstat_hostname);
                    event.set('sysstat_date', @@sysstat_date);
                    event.set('sysstat_report', @@sysstat_report);
                    "
          }
          if [sysstat_report] == 'cpu' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{NOTSPACE:core}%{SPACE}%{BASE10NUM:usr:float}%{SPACE}%{BASE10NUM:nice:float}%{SPACE}%{BASE10NUM:sys:float}%{SPACE}%{BASE10NUM:iowait:float}%{SPACE}%{BASE10NUM:steal:float}%{SPACE}%{BASE10NUM:irq:float}%{SPACE}%{BASE10NUM:soft:float}%{SPACE}%{BASE10NUM:quest:float}%{SPACE}%{BASE10NUM:idle:float}"
                  }
             }
          }
          if [sysstat_report] == 'task_system_switch' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:proc:float}%{SPACE}%{BASE10NUM:cswch:float}"
                  }
             }
          }
          if [sysstat_report] == 'swapping_stat' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:pswpin:float}%{SPACE}%{BASE10NUM:pswpout:float}"
                  }
             }
          }
          if [sysstat_report] == 'paging_stat' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:pgpgin:float}%{SPACE}%{BASE10NUM:pgpgout:float}%{SPACE}%{BASE10NUM:fault:float}%{SPACE}%{BASE10NUM:majflt:float}%{SPACE}%{BASE10NUM:pgfree:float}%{SPACE}%{BASE10NUM:pgscank:float}%{SPACE}%{BASE10NUM:pgscand:float}%{SPACE}%{BASE10NUM:pgsteal:float}%{SPACE}%{BASE10NUM:vmeff:float}"
                  }
             }
          }
          if [sysstat_report] == 'io' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:tps:float}%{SPACE}%{BASE10NUM:rtps:float}%{SPACE}%{BASE10NUM:wtps:float}%{SPACE}%{BASE10NUM:bread:float}%{SPACE}%{BASE10NUM:bwrtn:float}"
                  }
             }
          }
          if [sysstat_report] == 'memory_stat' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:frmpg:float}%{SPACE}%{BASE10NUM:bufpg:float}%{SPACE}%{BASE10NUM:campg:float}"
                  }
             }
          }
          if [sysstat_report] == 'memory_util' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:kbmemfree:int}%{SPACE}%{BASE10NUM:kbmemused:int}%{SPACE}%{BASE10NUM:memused:float}%{SPACE}%{BASE10NUM:kbbuffers:int}%{SPACE}%{BASE10NUM:kbcached:int}%{SPACE}%{BASE10NUM:kbcommit:int}%{SPACE}%{BASE10NUM:commit:float}"
                  }
             }
          }
          if [sysstat_report] == 'memory_util' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:kbmemfree:int}%{SPACE}%{BASE10NUM:kbmemused:int}%{SPACE}%{BASE10NUM:memused:float}%{SPACE}%{BASE10NUM:kbbuffers:int}%{SPACE}%{BASE10NUM:kbcached:int}%{SPACE}%{BASE10NUM:kbcommit:int}%{SPACE}%{BASE10NUM:commit:float}"
                  }
             }
          }
          if [sysstat_report] == 'swap_util' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:kbswpfree:int}%{SPACE}%{BASE10NUM:kbswpused:int}%{SPACE}%{BASE10NUM:swpused:float}%{SPACE}%{BASE10NUM:kbswpcad:int}%{SPACE}%{BASE10NUM:swpcad:float}"
                  }
             }
          }
          if [sysstat_report] == 'inode_file_other_kernel_tables' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:dentunusd:int}%{SPACE}%{BASE10NUM:file-nr:int}%{SPACE}%{BASE10NUM:inode-nr:int}%{SPACE}%{BASE10NUM:pty-nr:int}"
                  }
             }
          }
          if [sysstat_report] == 'queue_load_averages' {
             grok {
                  match => {
                        "message" => "%{HOUR:hour}時%{MINUTE:minute}分%{SECOND:second}秒%{SPACE}%{BASE10NUM:runq-sz:int}%{SPACE}%{BASE10NUM:plist-sz:int}%{SPACE}%{BASE10NUM:ldavg-1:float}%{SPACE}%{BASE10NUM:ldavg-5:float}%{SPACE}%{BASE10NUM:ldavg-15:float}"
                  }
             }
          }
          mutate {
                 add_field => { "[@metadata][datetime]" => "%{sysstat_date} %{hour}%{minute}%{second}" }
                 remove_field => [ "sysstat_date", "sysstat_report", "hour", "minute", "second" ]
          }
          date {
               match => [ "[@metadata][datetime]", "yyyyMMdd HHmmss" ]
               locale => en
          }
       }
}
output {
       stdout {
              codec => rubydebug
       }
#       elasticsearch {
#                     hosts => '127.0.0.1'
#                     index => "sysstat-%{+YYYY.MM.dd}"
#       }
}
